using Microsoft.Extensions.Logging;
using transacciones_flotantes.DTOs.TransaccionesFlotantes;
using transacciones_flotantes.Repositories.Interfaces;
using transacciones_flotantes.Services.Interfaces;

namespace transacciones_flotantes.Services.Services
{
    public class TransaccionesFlotantesService : ITransaccionesFlotantesService
    {
        private readonly ITransaccionFlotanteRepository _repository;
        private readonly IProveedorApiClient _proveedorClient;
        private readonly ILogger<TransaccionesFlotantesService> _logger;

        public TransaccionesFlotantesService(
            ITransaccionFlotanteRepository repository,
            IProveedorApiClient proveedorClient,
            ILogger<TransaccionesFlotantesService> logger)
        {
            _repository = repository;
            _proveedorClient = proveedorClient;
            _logger = logger;
        }

        public async Task<string> ProcesarAsync(TransaccionesFlotantesRequestDto request)
        {
            var data = await _repository.ObtenerDatosProveedorAsync(request.CounterpartCard);

            if (data == null)
                throw new Exception("Tarjeta no encontrada");

            var proveedorRequest = new ProveedorTransaccionFlotanteRequestDto
            {
                Card = new()
                {
                    Bin = data.Bin,
                    UltimosCuatroDigitos = data.UltimosCuatroDigitos
                },
                Client = new()
                {
                    NumeroDocumento = data.NumeroDocumento,
                    TipoDocumento = data.TipoDocumento,
                    Sexo = data.Sexo
                }
            };

            return await _proveedorClient.EnviarTransaccionAsync(proveedorRequest);
        }
    }
}
