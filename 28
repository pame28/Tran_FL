
No se puede convertir implícitamente el tipo 'int' en 'System.Collections.Generic.List<transacciones_flotantes.DTOs.Response.ResponseDto.LegacyAutorizacionDto>'






using System.Text.Json;
using transacciones_flotantes.DTOs.Response;
using transacciones_flotantes.DTOs.TransaccionesFlotantes;
using transacciones_flotantes.Repository.Interface;
using transacciones_flotantes.Service.Interface;
using static transacciones_flotantes.DTOs.TransaccionesFlotantes.ProveedorTransaccionesFlotantesResponseDto;

namespace transacciones_flotantes.Service
{
    public class TransaccionesFlotantesService : ITransaccionesFlotantesService
    {
        private readonly ITransaccionFlotanteRepository _repository;
        private readonly IProveedorApiClient _proveedorClient;
        private readonly ICatalogoErroresRepository _catalogoErrores;

        public TransaccionesFlotantesService(
            ITransaccionFlotanteRepository repository,
            IProveedorApiClient proveedorClient,
            ICatalogoErroresRepository catalogoErrores)
        {
            _repository = repository;
            _proveedorClient = proveedorClient;
            _catalogoErrores = catalogoErrores;
        }

        public async Task<LegacyTransaccionesResponseDto> ProcesarAsync(
            TransaccionesFlotantesRequestDto request)
        {
            var data =
                await _repository.ObtenerDatosProveedorAsync(request.CounterpartCard);

            if (data == null)
                return await CrearRespuestaError(2);

            var proveedorRequest = new ProveedorTransaccionFlotanteRequestDto
            {
                Card = new()
                {
                    Bin = data.Bin,
                    UltimosCuatroDigitos = data.UltimosCuatroDigitos
                },
                Client = new()
                {
                    NumeroDocumento = data.NumeroDocumento,
                    TipoDocumento = data.TipoDocumento,
                    Sexo = data.Sexo
                }
            };

            var rawResponse =
                await _proveedorClient.EnviarTransaccionAsync(proveedorRequest);

            var proveedorData =
                JsonSerializer.Deserialize<ProveedorResponseDto>(rawResponse)
                ?? throw new Exception("Respuesta inválida del proveedor");

            if (!proveedorData.Authorizations.Any())
                return await CrearRespuestaError(2);

            var catalogo = await _catalogoErrores.GetCatalogoResponseAsync(1);

            return new LegacyTransaccionesResponseDto
            {
                Result =
                {
                    Codigo = catalogo.Codigo,
                    Descripcion = catalogo.Descripcion
                },
                Respuesta = proveedorData.Authorizations.Select(a => new LegacyAutorizacionDto
                {
                    Date = a.Date,
                    Merchant_Name = a.Merchant_Name,
                    Amount = a.Amount,
                    Currency = a.Currency == "USD" ? "U$S" : a.Currency,
                    Reference = a.Reference
                }).ToList()
            };
        }

        private async Task<LegacyTransaccionesResponseDto> CrearRespuestaError(int codigo)
        {
            var catalogo = await _catalogoErrores.GetCatalogoResponseAsync(codigo);

            return new LegacyTransaccionesResponseDto
            {
                Result =
                {
                    Codigo = catalogo.Codigo,
                    Descripcion = catalogo.Descripcion
                },
                Respuesta = 0
            };
        }
    }
}












[HttpPost]
public async Task<IActionResult> Procesar(
    [FromBody] TransaccionesFlotantesRequestDto request)
{
    try
    {
        var response = await _service.ProcesarAsync(request);
        return Ok(response);
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Error no controlado");
        return StatusCode(500, new
        {
            codigo = 500,
            mensaje = ex.Message
        });
    }
}

