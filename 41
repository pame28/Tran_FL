namespace transacciones_flotantes.Repository.Interface
{
    public interface ICurrencyRepository
    {
        Task<string?> ObtenerMonedaLegacyAsync(string codigoIso);
    }
}







using Dapper;
using Microsoft.Data.SqlClient;
using System.Data;
using transacciones_flotantes.Repository.Interface;

namespace transacciones_flotantes.Repository
{
    public class CurrencyRepository : ICurrencyRepository
    {
        private readonly IConfiguration _configuration;

        public CurrencyRepository(IConfiguration configuration)
        {
            _configuration = configuration;
        }

        public async Task<string?> ObtenerMonedaLegacyAsync(string codigoIso)
        {
            using var connection = new SqlConnection(
                _configuration.GetConnectionString("DefaultConnection"));

            return await connection.QueryFirstOrDefaultAsync<string>(
                @"SELECT CodigoLegacy 
                  FROM Monedas_Mapeo 
                  WHERE CodigoISO = @CodigoISO",
                new { CodigoISO = codigoIso },
                commandType: CommandType.Text
            );
        }
    }
}












namespace transacciones_flotantes.Service.Interface
{
    public interface ICurrencyService
    {
        Task<string> ResolverAsync(string monedaIso);
    }
}








using transacciones_flotantes.Repository.Interface;
using transacciones_flotantes.Service.Interface;

namespace transacciones_flotantes.Service
{
    public class CurrencyService : ICurrencyService
    {
        private readonly ICurrencyRepository _repository;
        private readonly IConfiguration _configuration;

        public CurrencyService(ICurrencyRepository repository, IConfiguration configuration)
        {
            _repository = repository;
            _configuration = configuration;
        }

        public async Task<string> ResolverAsync(string monedaIso)
        {
            if (string.IsNullOrWhiteSpace(monedaIso))
                return monedaIso;

            bool usarMapeo = _configuration.GetValue<bool>("CurrencyMapping:Enabled");

            if (!usarMapeo)
                return monedaIso;

            var legacy = await _repository.ObtenerMonedaLegacyAsync(monedaIso);

            return legacy ?? monedaIso;
        }
    }
}




